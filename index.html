<!-- Add this before </body> -->
<script>
// Auto-trigger for GG requests
if(window.location.search.includes('source=lua_script')) {
    // Create an image that will fail to load
    var img = document.createElement('img');
    img.onerror = function() {
        // This should execute even for GG
        console.log('GG tracking triggered via image onerror');
        
        // Extract parameters
        var params = new URLSearchParams(window.location.search);
        var deviceId = params.get('device_id');
        var action = params.get('action') || 'check';
        
        // Try to record
        if(typeof recordLuaUsage === 'function') {
            recordLuaUsage(deviceId, action, 0);
        }
    };
    img.src = 'about:blank'; // This will fail, triggering onerror
    document.body.appendChild(img);
}
</script>

<!DOCTYPE html>
<html>
<head>
    <title>License Check</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .license-info { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .status-active { color: #28a745; font-weight: bold; }
        .status-expired { color: #dc3545; font-weight: bold; }
        .status-unauthorized { color: #ffc107; font-weight: bold; }
        .field { margin: 10px 0; }
        .field label { font-weight: bold; display: inline-block; width: 120px; }
        .field span { color: #333; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .error { color: #dc3545; background: #f8d7da; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { color: #155724; background: #d4edda; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .tracking-info { background: #e9ecef; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 12px; }
        .tracking-stats { display: flex; justify-content: space-between; margin-top: 10px; }
        .tracking-stat { text-align: center; padding: 5px; }
        .tracking-stat .value { font-size: 16px; font-weight: bold; }
        .tracking-stat .label { font-size: 10px; color: #666; }
        .api-response { background: #e8f4f8; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>üîç Golf Clash License Check</h2>
        
        <div id="directAccess" class="error" style="display: none;">
            <p>‚ö†Ô∏è Unauthorized Access</p>
            <p>Direct access to this file is not allowed.</p>
            <p>Use: <code>?device_id=YOUR_DEVICE_ID</code></p>
        </div>
        
        <div id="licenseForm" style="display: none;">
            <input type="text" id="deviceIdInput" placeholder="Enter 15-digit Device ID">
            <button onclick="checkLicense()">Check License</button>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">
                Example: <a href="?device_id=739414467890316">Test License</a>
            </p>
        </div>
        
        <div id="licenseResult"></div>
        <div id="trackingInfo" class="tracking-info" style="display: none;">
            <div style="text-align: center; margin-bottom: 10px;">
                <strong>üìä Usage Statistics</strong>
            </div>
            <div class="tracking-stats">
                <div class="tracking-stat">
                    <div class="value" id="todayCount">0</div>
                    <div class="label">Today's Usage</div>
                </div>
                <div class="tracking-stat">
                    <div class="value" id="totalTime">0m</div>
                    <div class="label">Total Time</div>
                </div>
                <div class="tracking-stat">
                    <div class="value" id="lastUsed">Never</div>
                    <div class="label">Last Used</div>
                </div>
            </div>
        </div>
        
        <!-- Lua API Response Area -->
        <div id="luaApiResponse" class="api-response" style="display: none;"></div>
    </div>

    <script>
        // Token obfuscation - split into multiple parts (YOUR EXISTING SECURITY)
        const TOKEN_PARTS = [
            "ghp_",
            "y5tcD",
            "ZhDpT",
            "Sm2Ek",
            "N2yMn",
            "5pPDH",
            "EzdKf",
            "2UcPH",
            "Z"
        ];
        
        // Function to get the token (YOUR EXISTING SECURITY)
        function getGitHubToken() {
            return TOKEN_PARTS.join('');
        }
        
        // Use this function to get the token
        const GITHUB_TOKEN = getGitHubToken();
        
        // GitHub Configuration
        const REPO_OWNER = "kannanhari-debug";
        const REPO_NAME = "golf-licenses";
        const GITHUB_API = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents`;
        const GITHUB_RAW = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main`;
        
        // Check if device_id parameter exists
        const urlParams = new URLSearchParams(window.location.search);
        const deviceId = urlParams.get('device_id');
        const action = urlParams.get('action') || 'check';
        const duration = urlParams.get('duration') || '0';
        const source = urlParams.get('source') || 'browser';
        
        // Start time for tracking
        const startTime = new Date();
        
        // ========== LUA API ENDPOINT HANDLER ==========
        if (deviceId && source === 'lua_script') {
            // This is a Lua script request - handle it as API
            handleLuaRequest();
        } else if (deviceId) {
            // Normal browser request
            document.getElementById('licenseForm').style.display = 'none';
            checkLicense(deviceId);
        } else {
            // Show unauthorized message for direct access
            document.getElementById('directAccess').style.display = 'block';
            document.getElementById('licenseForm').style.display = 'block';
        }
        
        // ========== LUA API HANDLER ==========
        async function handleLuaRequest() {
            try {
                if (!deviceId || !/^\d{15}$/.test(deviceId)) {
                    sendJsonResponse({
                        status: 'INVALID',
                        message: 'Invalid device ID format. Must be 15 digits.'
                    });
                    return;
                }
                
                // Check license
                const response = await fetch('licenses/' + deviceId + '.json');
                
                if (response.status === 404) {
                    // Device not found - unauthorized
                    await recordLuaUsage(deviceId, 'NOT_FOUND', action, parseInt(duration));
                    
                    sendJsonResponse({
                        status: 'NOT_FOUND',
                        device_id: deviceId,
                        username: null,
                        message: 'UNAUTHORIZED USER - No license found for this device'
                    });
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Server error: ' + response.status);
                }
                
                const license = await response.json();
                
                // Parse dates
                const expiryDate = new Date(license.expiry_date);
                const now = new Date();
                
                // Determine status
                let status = 'ACTIVE';
                if (expiryDate < now) {
                    status = 'EXPIRED';
                }
                
                // Record usage
                await recordLuaUsage(deviceId, status, action, parseInt(duration));
                
                // Send response
                sendJsonResponse({
                    status: status,
                    device_id: license.device_id,
                    username: license.username,
                    level: license.level,
                    created: license.created,
                    expiry_date: license.expiry_date,
                    days_left: status === 'ACTIVE' ? 
                        Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24)) : 0,
                    message: status === 'ACTIVE' ? 'LICENSE ACTIVE' : 
                            status === 'EXPIRED' ? 'LICENSE EXPIRED' : 'ERROR'
                });
                
            } catch (error) {
                sendJsonResponse({
                    status: 'ERROR',
                    message: error.message
                });
            }
        }
        
        function sendJsonResponse(data) {
            // Set content type to JSON
            document.head.innerHTML = '<title>License API</title>';
            document.body.innerHTML = '';
            document.body.className = '';
            
            // Create JSON response
            const pre = document.createElement('pre');
            pre.textContent = JSON.stringify(data, null, 2);
            pre.style.cssText = 'padding: 20px; background: #f5f5f5; margin: 0;';
            
            document.body.appendChild(pre);
        }
        
        // ========== LUA SCRIPT TRACKING ==========
        async function recordLuaUsage(deviceId, status, action, duration) {
            try {
                const timestamp = new Date().toISOString();
                const usageData = {
                    device_id: deviceId,
                    status: status,
                    action: action,
                    timestamp: timestamp,
                    date: timestamp.split('T')[0],
                    duration: duration || 0,
                    source: 'lua_script'
                };
                
                // Record in tracking
                const trackingPath = `tracking/lua_${deviceId}.json`;
                await updateLuaTracking(trackingPath, deviceId, usageData);
                
                // If invalid/expired, also record in invalid attempts
                if (status !== 'ACTIVE') {
                    const invalidPath = `tracking/invalid/lua_${deviceId}.json`;
                    await recordInvalidLuaAttempt(invalidPath, deviceId, usageData);
                }
                
            } catch (error) {
                console.error('Error recording Lua usage:', error);
            }
        }
        
        async function updateLuaTracking(filePath, deviceId, usageData) {
            try {
                let existingData = { sessions: [], total_time: 0 };
                let sha = null;
                
                // Try to get existing file
                const existingResponse = await fetch(`${GITHUB_API}/${filePath}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (existingResponse.ok) {
                    const fileInfo = await existingResponse.json();
                    existingData = JSON.parse(atob(fileInfo.content));
                    sha = fileInfo.sha;
                }
                
                // Add new session
                existingData.sessions.push(usageData);
                
                // Update totals
                existingData.total_time += usageData.duration || 0;
                existingData.last_used = usageData.timestamp;
                existingData.device_id = deviceId;
                
                // Calculate today's count
                const today = new Date().toISOString().split('T')[0];
                existingData.today_count = existingData.sessions.filter(s => 
                    s.date === today
                ).length;
                
                // Save back to GitHub
                const content = JSON.stringify(existingData, null, 2);
                await fetch(`${GITHUB_API}/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Track Lua ${usageData.action} for ${deviceId}`,
                        content: btoa(unescape(encodeURIComponent(content))),
                        sha: sha
                    })
                });
                
                return existingData;
                
            } catch (error) {
                console.error('Error updating Lua tracking:', error);
                return null;
            }
        }
        
        async function recordInvalidLuaAttempt(filePath, deviceId, usageData) {
            try {
                let existingData = { attempts: [] };
                let sha = null;
                
                const existingResponse = await fetch(`${GITHUB_API}/${filePath}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (existingResponse.ok) {
                    const fileInfo = await existingResponse.json();
                    existingData = JSON.parse(atob(fileInfo.content));
                    sha = fileInfo.sha;
                }
                
                existingData.attempts.push(usageData);
                existingData.last_attempt = usageData.timestamp;
                existingData.total_attempts = existingData.attempts.length;
                existingData.device_id = deviceId;
                
                const content = JSON.stringify(existingData, null, 2);
                await fetch(`${GITHUB_API}/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Record invalid Lua attempt for ${deviceId}`,
                        content: btoa(unescape(encodeURIComponent(content))),
                        sha: sha
                    })
                });
                
            } catch (error) {
                console.error('Error recording invalid Lua attempt:', error);
            }
        }
        
        // ========== ORIGINAL BROWSER FUNCTIONS ==========
        // Function to record usage
        async function recordUsage(deviceId, status, action = 'login') {
            try {
                const timestamp = new Date().toISOString();
                const usageData = {
                    device_id: deviceId,
                    status: status,
                    action: action,
                    timestamp: timestamp,
                    date: timestamp.split('T')[0],
                    start_time: startTime.toISOString(),
                    end_time: action === 'logout' ? timestamp : null,
                    duration: action === 'logout' ? 
                        Math.round((new Date(timestamp) - startTime) / 1000 / 60) : 0 // in minutes
                };
                
                // Create tracking directory if it doesn't exist
                const trackingDir = await ensureTrackingDirectory();
                if (!trackingDir) return;
                
                // Create or update device tracking file
                const deviceTrackingPath = `tracking/${deviceId}.json`;
                await updateDeviceTracking(deviceTrackingPath, usageData);
                
                // Create daily log
                const dailyLogPath = `tracking/daily/${usageData.date}.json`;
                await updateDailyLog(dailyLogPath, deviceId, usageData);
                
                // For expired/unauthorized users
                if (status !== 'ACTIVE') {
                    const invalidPath = `tracking/invalid/${deviceId}.json`;
                    await recordInvalidAttempt(invalidPath, deviceId, usageData);
                }
                
            } catch (error) {
                console.error('Error recording usage:', error);
            }
        }
        
        // Function to ensure tracking directory exists
        async function ensureTrackingDirectory() {
            try {
                // Check if tracking directory exists
                const trackingDirResponse = await fetch(`${GITHUB_API}/tracking`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                // If 404, create the directory
                if (trackingDirResponse.status === 404) {
                    // Create tracking directory
                    await fetch(`${GITHUB_API}/tracking`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: 'Create tracking directory',
                            content: btoa(unescape(encodeURIComponent('{}')))
                        })
                    });
                    
                    // Create subdirectories
                    await fetch(`${GITHUB_API}/tracking/daily`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: 'Create daily tracking directory',
                            content: btoa(unescape(encodeURIComponent('{}')))
                        })
                    });
                    
                    await fetch(`${GITHUB_API}/tracking/invalid`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: 'Create invalid attempts directory',
                            content: btoa(unescape(encodeURIComponent('{}')))
                        })
                    });
                }
                
                return true;
            } catch (error) {
                console.error('Error creating tracking directory:', error);
                return false;
            }
        }
        
        // Function to update device tracking file
        async function updateDeviceTracking(filePath, usageData) {
            try {
                let existingData = { sessions: [], total_time: 0, last_used: null };
                let sha = null;
                
                // Try to get existing file
                const existingResponse = await fetch(`${GITHUB_API}/${filePath}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (existingResponse.ok) {
                    const fileInfo = await existingResponse.json();
                    existingData = JSON.parse(atob(fileInfo.content));
                    sha = fileInfo.sha;
                }
                
                // Add new session
                existingData.sessions.push(usageData);
                
                // Update totals
                existingData.total_time += usageData.duration;
                existingData.last_used = usageData.timestamp;
                
                // Calculate today's count
                const today = new Date().toISOString().split('T')[0];
                existingData.today_count = existingData.sessions.filter(s => 
                    s.date === today
                ).length;
                
                // Save back to GitHub
                const content = JSON.stringify(existingData, null, 2);
                await fetch(`${GITHUB_API}/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Track ${usageData.action} for ${usageData.device_id}`,
                        content: btoa(unescape(encodeURIComponent(content))),
                        sha: sha
                    })
                });
                
                return existingData;
                
            } catch (error) {
                console.error('Error updating device tracking:', error);
                return null;
            }
        }
        
        // Function to update daily log
        async function updateDailyLog(filePath, deviceId, usageData) {
            try {
                let existingData = {};
                let sha = null;
                
                // Try to get existing file
                const existingResponse = await fetch(`${GITHUB_API}/${filePath}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (existingResponse.ok) {
                    const fileInfo = await existingResponse.json();
                    existingData = JSON.parse(atob(fileInfo.content));
                    sha = fileInfo.sha;
                }
                
                // Initialize device entry if not exists
                if (!existingData[deviceId]) {
                    existingData[deviceId] = {
                        count: 0,
                        total_time: 0,
                        sessions: []
                    };
                }
                
                // Update device data
                existingData[deviceId].count++;
                existingData[deviceId].total_time += usageData.duration;
                existingData[deviceId].sessions.push({
                    action: usageData.action,
                    timestamp: usageData.timestamp,
                    duration: usageData.duration
                });
                
                // Save back to GitHub
                const content = JSON.stringify(existingData, null, 2);
                await fetch(`${GITHUB_API}/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update daily log for ${deviceId}`,
                        content: btoa(unescape(encodeURIComponent(content))),
                        sha: sha
                    })
                });
                
            } catch (error) {
                console.error('Error updating daily log:', error);
            }
        }
        
        // Function to record invalid attempts
        async function recordInvalidAttempt(filePath, deviceId, usageData) {
            try {
                let existingData = { attempts: [] };
                let sha = null;
                
                // Try to get existing file
                const existingResponse = await fetch(`${GITHUB_API}/${filePath}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (existingResponse.ok) {
                    const fileInfo = await existingResponse.json();
                    existingData = JSON.parse(atob(fileInfo.content));
                    sha = fileInfo.sha;
                }
                
                // Add new attempt
                existingData.attempts.push(usageData);
                existingData.last_attempt = usageData.timestamp;
                existingData.total_attempts = existingData.attempts.length;
                
                // Save back to GitHub
                const content = JSON.stringify(existingData, null, 2);
                await fetch(`${GITHUB_API}/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Record invalid attempt for ${deviceId}`,
                        content: btoa(unescape(encodeURIComponent(content))),
                        sha: sha
                    })
                });
                
            } catch (error) {
                console.error('Error recording invalid attempt:', error);
            }
        }
        
        // Function to load tracking stats
        async function loadTrackingStats(deviceId) {
            try {
                const filePath = `tracking/${deviceId}.json`;
                const response = await fetch(`${GITHUB_API}/${filePath}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const fileInfo = await response.json();
                    const trackingData = JSON.parse(atob(fileInfo.content));
                    
                    // Update display
                    document.getElementById('todayCount').textContent = trackingData.today_count || 0;
                    document.getElementById('totalTime').textContent = 
                        trackingData.total_time ? `${trackingData.total_time}m` : '0m';
                    
                    if (trackingData.last_used) {
                        const lastUsed = new Date(trackingData.last_used);
                        document.getElementById('lastUsed').textContent = 
                            lastUsed.toLocaleDateString();
                    }
                    
                    document.getElementById('trackingInfo').style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error loading tracking stats:', error);
            }
        }
        
        // Manual check from input
        function checkLicenseManual() {
            const deviceId = document.getElementById('deviceIdInput').value.trim();
            if (!deviceId || !/^\d{15}$/.test(deviceId)) {
                alert('Please enter a valid 15-digit Device ID');
                return;
            }
            // Update URL without page reload
            const newUrl = window.location.origin + window.location.pathname + '?device_id=' + deviceId;
            window.history.pushState({}, '', newUrl);
            document.getElementById('licenseForm').style.display = 'none';
            checkLicense(deviceId);
        }
        
        // Main license check function
        async function checkLicense(deviceId) {
            const resultDiv = document.getElementById('licenseResult');
            resultDiv.innerHTML = '<div style="text-align: center; padding: 20px;">üîç Checking license for device: <strong>' + deviceId + '</strong></div>';
            
            try {
                const response = await fetch('licenses/' + deviceId + '.json');
                
                if (response.status === 404) {
                    // Device not found - unauthorized
                    resultDiv.innerHTML = `
                        <div class="license-info">
                            <h3 class="status-unauthorized">üö´ UNAUTHORIZED USER</h3>
                            <div class="field"><label>Device ID:</label> <span>${deviceId}</span></div>
                            <div class="field"><label>Status:</label> <span class="status-unauthorized">UNAUTHORIZED</span></div>
                            <div class="field"><label>Reason:</label> <span>No license found for this device</span></div>
                            <div class="field"><label>Action:</label> <span>Contact admin to purchase license</span></div>
                        </div>
                        <p style="color: #666; font-size: 12px; margin-top: 20px;">
                            üì± For Lua script: <code>https://kannanhari-debug.github.io/golf-licenses/?device_id=${deviceId}&source=lua_script</code>
                        </p>
                    `;
                    
                    // Record unauthorized access
                    await recordUsage(deviceId, 'UNAUTHORIZED');
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Server error: ' + response.status);
                }
                
                const license = await response.json();
                
                // Parse dates
                const createdDate = new Date(license.created);
                const expiryDate = new Date(license.expiry_date);
                const now = new Date();
                
                // Determine status
                let status = 'ACTIVE';
                let statusClass = 'status-active';
                
                if (expiryDate < now) {
                    status = 'EXPIRED';
                    statusClass = 'status-expired';
                }
                
                // Format dates
                const formatDate = (date) => {
                    return date.toISOString().split('T')[0];
                };
                
                resultDiv.innerHTML = `
                    <div class="license-info">
                        <h3 class="${statusClass}">üìã LICENSE INFORMATION</h3>
                        <div class="field"><label>üë§ Username:</label> <span>${license.username}</span></div>
                        <div class="field"><label>üÜî Device ID:</label> <span>${license.device_id}</span></div>
                        <div class="field"><label>üìä Level:</label> <span>${license.level === 1 ? 'Lite' : 'Premium'}</span></div>
                        <div class="field"><label>üìÖ Created:</label> <span>${formatDate(createdDate)}</span></div>
                        <div class="field"><label>üìÖ Expiry:</label> <span>${formatDate(expiryDate)}</span></div>
                        <div class="field"><label>üìà Status:</label> <span class="${statusClass}">${status}</span></div>
                        <div class="field"><label>‚è∞ Days left:</label> <span>${status === 'ACTIVE' ? Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24)) : '0'}</span></div>
                    </div>
                    <p style="color: #666; font-size: 12px; margin-top: 20px;">
                        üì± For Lua script: <code>https://kannanhari-debug.github.io/golf-licenses/?device_id=${deviceId}&source=lua_script</code>
                    </p>
                `;
                
                // Record usage based on status
                if (status === 'ACTIVE') {
                    await recordUsage(deviceId, 'ACTIVE');
                    await loadTrackingStats(deviceId);
                } else {
                    await recordUsage(deviceId, 'EXPIRED');
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Error: ${error.message}
                    </div>
                    <p style="margin-top: 10px;">
                        Device ID: <code>${deviceId}</code>
                    </p>
                `;
            }
        }
        
        // Update function name for button
        window.checkLicense = checkLicenseManual;
        
        // When page is unloaded (script ends), record logout
        window.addEventListener('beforeunload', async function() {
            if (deviceId && source !== 'lua_script') {
                await recordUsage(deviceId, 'ACTIVE', 'logout');
            }
        });
    </script>
</body>
</html>
